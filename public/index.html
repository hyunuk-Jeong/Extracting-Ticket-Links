<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í‹°ì¼“ë§í¬ ê²½ê¸° ì¼ì • Â· ì§ë§ ìƒì„±</title>
  <link rel="icon" href="/favicon.png" type="image/png">
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    table,
    th,
    td {
      border: 1px solid #ddd;
    }

    th,
    td {
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    .button-container {
      margin-bottom: 20px;
    }

    .button-container button {
      margin: 5px;
      padding: 10px;
    }

    .link-display {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
    }

    tr.open {
      background-color: #e6ffe6;
      /* ì—°ë‘ìƒ‰ */
    }

    tr.upcoming {
      background-color: #fff0f0;
      /* ì—°ë¶„í™ */
    }
  </style>
</head>

<body>
  <h1>í‹°ì¼“ë§í¬ ê²½ê¸° ì¼ì •</h1>

  <div class="button-container">
    <button class="fetchDataButton" data-teamId="59">LG íŠ¸ìœˆìŠ¤</button>
    <button class="fetchDataButton" data-teamId="63">í•œí™” ì´ê¸€ìŠ¤</button>
    <button class="fetchDataButton" data-teamId="476">SSG ëœë”ìŠ¤</button>
    <button class="fetchDataButton" data-teamId="57">ì‚¼ì„± ë¼ì´ì˜¨ì¦ˆ</button>
    <button class="fetchDataButton" data-teamId="58">ê¸°ì•„ íƒ€ì´ê±°ì¦ˆ</button>
    <button class="fetchDataButton" data-teamId="62">KT ìœ„ì¦ˆ</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ì¹´í…Œê³ ë¦¬ ID</th>
        <th>ì¼ì • ID</th>
        <th>ìƒí’ˆ ID</th>
        <th>ê²½ê¸° ì œëª©</th>
        <th>í™ˆíŒ€</th>
        <th>ì›ì •íŒ€</th>
        <th>ì¥ì†Œ</th>
        <th>ì¼ì • ë‚ ì§œ</th>
        <th>ì˜ˆë§¤ ì˜¤í”ˆ ë‚ ì§œ</th>
        <th>ì§ë§ ì¶”ì¶œí•˜ê¸°</th>
      </tr>
    </thead>
    <tbody id="scheduleTableBody">
      <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </tbody>
  </table>

  <div class="link-display" id="linkDisplay"></div>

  <script>
    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.querySelectorAll('.fetchDataButton').forEach(button => {
      button.addEventListener('click', function () {

        const teamId = this.getAttribute('data-teamId');

        const url = `https://my-vercel-proxy-gilt.vercel.app/api/proxy?url=` + encodeURIComponent(`https://mapi.ticketlink.co.kr/mapi/sports/schedules?categoryId=137&teamId=${teamId}`);


        fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok.');
            }
            return response.json();
          })
          .then(data => {
            try {
              const schedules = data.body.data.schedules; // ì¼ì • ë°°ì—´

              // ê²°ê³¼ë¬¼ ì¶œë ¥ (ì½˜ì†”ì— ì¶œë ¥)
              console.log('Schedules Array:', schedules); // schedules ë°°ì—´ ì¶œë ¥

              // í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ë™ì ìœ¼ë¡œ ì‚½ì…í•˜ëŠ” í•¨ìˆ˜
              function populateTable(data) {
                const tableBody = document.getElementById('scheduleTableBody');
                tableBody.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì œê±°

                data.forEach(item => {
                  const row = document.createElement('tr');

                  const now = Date.now();
                  const reserveTime = new Date(item.reserveOpenDate).getTime();

                  if (now >= reserveTime) {
                    row.classList.add('open');     // ì˜ˆë§¤ ê°€ëŠ¥
                  } else {
                    row.classList.add('upcoming'); // ì˜ˆë§¤ ì˜ˆì •
                  }

                  // ê° í•­ëª©ì˜ ê°’ë“¤ì„ ì¶”ì¶œí•˜ê³  í…œí”Œë¦¿ì— ì±„ìš°ê¸°
                  row.innerHTML = `
                    <td>${item.categoryId}</td>
                    <td>${item.scheduleId}</td>
                    <td>${item.productId}</td>
                    <td>${item.matchTitle}</td>
                    <td>${item.homeTeam ? item.homeTeam.teamName : 'ì •ë³´ ì—†ìŒ'}</td>
                    <td>${item.awayTeam ? item.awayTeam.teamName : 'ì •ë³´ ì—†ìŒ'}</td>
                    <td>${item.venueName}</td>
                    <td>${new Date(item.scheduleDate).toLocaleString()}</td>
                    <td>${new Date(item.reserveOpenDate).toLocaleString()}</td>
                    <td><button class="extractLinkButton" data-matchTitle="${item.matchTitle}" data-reserveDate="${new Date(item.reserveOpenDate).toLocaleString()}" data-scheduleId="${item.scheduleId}" data-productId="${item.productId}">ì§ë§ ì¶”ì¶œí•˜ê¸°</button></td>
                  `;
                  tableBody.appendChild(row);
                });

                // ì§ë§ ì¶”ì¶œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                document.querySelectorAll('.extractLinkButton').forEach(button => {
                  button.addEventListener('click', function () {
                    const matchTitle = this.getAttribute('data-matchTitle');
                    const reserveDate = this.getAttribute('data-reserveDate');
                    const scheduleId = this.getAttribute('data-scheduleId');
                    const productId = this.getAttribute('data-productId');

                    // ë§í¬ ìƒì„±
                    const pcLink = `https://www.ticketlink.co.kr/reserve/product/${productId}?scheduleId=${scheduleId}`;
                    const mobileLink = `https://m.ticketlink.co.kr/reserve/product/${productId}?scheduleId=${scheduleId}`;

                    const linkDisplay = document.getElementById('linkDisplay');
                    linkDisplay.innerHTML = `
                      <strong>${matchTitle}</strong><br>
                      ì˜ˆë§¤ì¼ì‹œ: ${reserveDate}<br><br>
                      PC: <a href="${pcLink}" target="_blank">${pcLink}</a>
<button class="copy-button" data-clipboard-text="${pcLink}">PC ë§í¬ë³µì‚¬</button>
<br>
                      ëª¨ë°”ì¼: <a href="${mobileLink}" target="_blank">${mobileLink}</a>
		      <button class="copy-button" data-clipboard-text="${mobileLink}">ëª¨ë°”ì¼ ë§í¬ë³µì‚¬</button>
                    `;
                    // ë³µì‚¬ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    document.querySelectorAll('.copy-button').forEach(copyButton => {
                      copyButton.addEventListener('click', function () {
                        const linkToCopy = this.getAttribute('data-clipboard-text');
                        // í´ë¦½ë³´ë“œì— í…ìŠ¤íŠ¸ ë³µì‚¬
                        const textArea = document.createElement('textarea');
                        textArea.value = linkToCopy;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);

                        alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                      });
                    });
                  });
                });
              }

              // ë°ì´í„° í‘œì‹œ
              populateTable(schedules);

            } catch (error) {
              document.getElementById('scheduleTableBody').innerHTML = 'JSON íŒŒì‹± ì˜¤ë¥˜: ' + error.message;
            }
          })
          .catch(error => {
            document.getElementById('scheduleTableBody').innerHTML = 'Error: ' + error.message;
          });
      });
    });

    async function getServerTime() {
      try {
        const res = await fetch('/api/server-time');
        const data = await res.json();
        const serverTime = new Date(data.serverTime);
        const clientTime = new Date();

        const diff = serverTime - clientTime;

        console.log('ğŸ“¡ ì„œë²„ ì‹œê°„:', serverTime.toISOString());
        console.log('ğŸ–¥ï¸ í´ë¼ì´ì–¸íŠ¸ ì‹œê°„:', clientTime.toISOString());
        console.log('â±ï¸ ì‹œê°„ ì°¨ì´(ms):', diff);

        // í•„ìš” ì‹œ, ë³´ì •ëœ ì‹œê°„ ê³„ì‚°ë„ ê°€ëŠ¥
        const correctedTime = new Date(Date.now() + diff);
        console.log('ğŸ› ï¸ ë³´ì •ëœ ì‹œê°„:', correctedTime.toISOString());
      } catch (err) {
        console.error('ì„œë²„ ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
      }
    }

    getServerTime();

  </script>
</body>

</html>